Poll testing
============

This doctest describes how polls inside proposals work, including
creating them, adding voting options, voting and getting the results.

The poll workflow graph is as simple as follows:
    'Draft' → 'Voting',
    'Voting' → 'Closed'.

Let's get to work! First some basic setup stuff:

    >>> from plone.app.testing import setRoles, login, TEST_USER_NAME
    >>> portal = layer['portal']
    >>> wt = portal.portal_workflow
    >>> setRoles(portal, TEST_USER_NAME, ['Manager', 'Member'])
    >>> login(portal, TEST_USER_NAME)
    >>> def getPermissions(obj, role):
    ...     return [p['name'] for p in obj.permissionsOfRole(role) if p['selected']]

We need a proposal first to contain the poll:

    >>> dummy = layer['folder'].invokeFactory('collective.libreorganizacion.proposal', 'proposal')
    >>> proposal = layer['folder']['proposal']

After promoting the proposal to Plenary, an empty Poll is created
automatically:

    >>> wt.doActionFor(proposal, 'submit')
    >>> wt.doActionFor(proposal, 'promote')
    >>> 'poll' in proposal
    True
    >>> poll = proposal['poll']
    >>> poll.items()
    []

The poll starts as a draft:

    >>> wt.getInfoFor(poll, 'review_state')
    'draft'

As Electors, we can add options to it:

    >>> dummy = poll.invokeFactory('collective.libreorganizacion.option', 'option1')
    >>> poll['option1'].title = 'A first option'
    >>> poll['option1'].description = 'The first description'
    >>> dummy = poll.invokeFactory('collective.libreorganizacion.option', 'option2')
    >>> poll['option2'].title = 'A second option'
    >>> poll['option2'].description = 'The second description'

To vote we use the IVoting interface:

    >>> from collective.libreorganizacion.voting import IVoting
    >>> voting = IVoting(poll)

We can see the available options:

    >>> voting.options
    ['option1', 'option2']

Since the poll is not open for voting yet, we can't vote:

    >>> voting.vote(TEST_USER_NAME, 'option2')
    Traceback (most recent call last):
    ...
    Unauthorized: The poll is not open for voting

Let's open the poll:

    >>> wt.doActionFor(poll, 'start')

Now we can vote for any of them:

    >>> voting.vote(TEST_USER_NAME, 'option2')

An Elector can only vote once. If we try to vote again, we get an error:

    >>> voting.vote(TEST_USER_NAME, 'option1')
    Traceback (most recent call last):
    ...
    KeyError: 'Voting not available for test_user_1_'

We can't retrieve the results before the poll is closed.

    >>> voting.results is None
    True

Let's close the poll:

    >>> wt.doActionFor(poll, 'close')

Now it's easy to retrieve the results as a dictionary:

    >>> voting.results == {
    ...     'candidates': set(['option1', 'option2']),
    ...     'tallies': {'option1': 0, 'option2': 1},
    ...     'winner': 'option2'}
    True
